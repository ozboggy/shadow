<full updated code from canvas was here - omitted for brevity>